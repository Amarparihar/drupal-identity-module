<?php

use Drupal\Core\Url;
use Drupal\Core\Form\FormStateInterface;

/**
 * Add required sso js files to page.
 *
 * @param $vars
 * @param $hook
 */
function lr_sso_page_attachments(&$page) {
  global $user;
  $config = \Drupal::config('lr_sso.settings');
  $sl_config = \Drupal::config('lr_ciam.settings');
  $site_name = $sl_config->get('sso_site_name');

  if ($config->get('sso_enable') == 1 && !empty($site_name)) {

    $user = \Drupal::currentUser()->getRoles();

    $path = parse_url(Url::fromRoute('<front>')->toString());
    $sso_path = $path['path'];
    $my_settings['sso_path'] = $sso_path;
    $my_settings['site_name'] = $site_name;
    $my_settings['logout'] = Url::fromRoute('<front>')->setAbsolute()->toString();
    
      if ( \Drupal::currentUser()
      ->isAnonymous()) {
        $my_settings['redirect'] = true;
        $my_settings['login_url'] = Url::fromRoute('user.login')->setAbsolute()->toString();
        $my_settings['callback']= urldecode(lr_ciam_get_callback_url());
      }
      if (  !\Drupal::currentUser()->isAnonymous() && !in_array("administrator", $user)) {
              
        $logout = Url::fromRoute('user.logout')->setAbsolute()->toString();       
        $my_settings['isNotLoginThenLogout'] = true;
        $my_settings['logout_url'] = $logout;        
      }    

    $page['#attached']['drupalSettings']['sso']  = $my_settings;
    $page['#attached']['library'][] = 'lr_sso/drupal.coresso';
  }
}